default:
  image:
    name: prplfoundationinc/prplmesh-builder:ubuntu-18.04
    entrypoint: [""]

variables:
  BASE_IMAGE: ubuntu:18.04
  IMAGE_TAG: ubuntu-18.04-$CI_CONCURRENT_PROJECT_ID

build-builder:
  stage: .pre
  image: docker:19.03.5-dind
  services:
    - docker:19.03.5-dind

  script:
    docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    tools/docker/image-build.sh \
      --base-image "$BASE_IMAGE" \
      --tag "$IMAGE_TAG" \
      --push "$CI_REGISTRY"

clang-format:
  stage: build
  image: $IMAGE_TAG
  script:
    # Run clang-format and check there are no modified files by checking git status
    - ./clang-format.sh
    - git update-index -q --refresh
    - git diff-index --exit-code HEAD

build-in-docker:
  stage: build
  script:
    - tools/maptools.py build map -f CMAKE_BUILD_TYPE=Debug BUILD_TESTS=ON
    # Check that the AutoGenerated files are correct by checking git status
    - git update-index -q --refresh
    - git diff-index --exit-code HEAD

run-tests:
  stage: test
  image: docker
  script:
    - cd tools/docker
    # Try to pull from dockerhub, build the container images if that fails
    - ./image-pull.sh || ./image-build.sh
    - ./run.sh -f -d --entrypoint "$PWD/../../../build/install/bin/tests/tlvf_test"
    - ./tests/test_flows.sh -v

  after_script:
    - tools/docker/stop.sh -k -r

  tags:
    - dockerbuild
